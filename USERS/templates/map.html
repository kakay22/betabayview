{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Overview - Beta Bayview Homes</title>
    <link rel="icon" href="{% static 'users/betaIcon (1).png' %}" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="{% static 'js/map.js' %}"></script>
    <!-- <script src="{% static 'js/preload.js' %}"></script> -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'js/loading_submit.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/user-pop-up-mess.css' %}">
</head>

<body class="relative h-[100dvh] w-[100dvw] overflow-y-scroll overflow-x-hidden">
    <img class="absolute h-full w-full top-0 left-0" src="{% static 'users/pope-francis-village.png' %}" alt="">

    <!-- Loading Spinner (hidden until request is sent) -->
	<div id="loadingSpinner" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-800 bg-opacity-50 hidden z-[999999999999]">
		<div class="spinner-border text-primary" role="status">
		</div>
		<span class="">Loading...</span>
	</div>

    {% for message in messages %}
	<p id="pop-up-mess"
		class="alert py-2 absolute border-none bg-white shadow-md shadow-gray-400 text-black">
		{% if message.tags == 'error' %}
			<i class="bi bi-x-circle-fill text-red-600"></i> {{ message }}
		{% elif message.tags == 'success' %}
			<i class="bi bi-check-circle-fill text-green-600"></i> {{ message }}
		{% else %}
			<i class="bi bi-info-circle-fill text-blue-600"></i> {{ message }}
		{% endif %}
	</p>
	{% endfor %}

    <div class="shadow-md bg-gray-100 z-[99] flex justify-center items-center absolute h-[100%] w-full"
        style="background-color: rgba(255, 255, 255, .8);">

        <!-- Content -->
        <div class="bg-white md:flex h-full md:mb-10 md:h-[80%] w-full md:w-[80%] min-[1075px]:w-[95%]">            
         <!-- Map Container-->
         <div id="mapContainer"
            class="fixed inset-0 z-[100] bg-white bg-opacity-90 flex justify-end items-center">

            <!-- Sidebar Map -->
            <div id="sidebarMap" class="h-full w-[45%] md:w-[15%] fixed -left-[100%] top-0 md:left-0 shadow-md bg-white transition-all duration-300 ease-in-out z-[9999999]">
                <!-- Filter Buttons -->
                <div id="filterButtons" class="flex flex-col space-y-1">
                    <div class="w-full flex font-bold justify-between py-3 px-2 items-center">
                        <p>Beta Bayview Homes</p>
                        <i id="closeSidebarBtn" class="bi bi-x md:hidden text-[1.5rem] cursor-pointer"></i>
                    </div>
                    <hr class="my-0">

                    <a href="?filter=houses" 
                        class="filter-button py-3 px-4 text-left w-full hover:bg-gray-200 text-gray-700 
                        {% if filter_type == 'houses' %}bg-green-500 text-white{% else %}bg-white{% endif %}">
                            <i class="bi bi-houses"></i> Houses
                        </a>
                        <a href="?filter=events" 
                        class="filter-button py-3 px-4 text-left w-full hover:bg-gray-200 text-gray-700 
                        {% if filter_type == 'events' %}bg-green-500 text-white{% else %}bg-white{% endif %}">
                            <i class="bi bi-calendar"></i> Events
                        </a>

                    <!-- Button to trigger the modal -->
                    <button 
                        id="eventsBtnFilter" 
                        class="filter-button py-3 px-4 text-left w-full hover:bg-gray-200 text-gray-700 active:bg-green-500 active:text-white"
                        data-bs-toggle="modal" 
                        data-bs-target="#myVisitRequestModal">
                        <i class="bi bi-person-bounding-box"></i> My Visit Request
                    </button>

                    <!-- Modal for My visit request -->
                    <div class="modal fade" id="myVisitRequestModal" tabindex="-1" aria-labelledby="myVisitRequestModalLabel" aria-hidden="true" data-bs-backdrop="false">
                        <div class="modal-dialog modal-lg"> <!-- Make the modal larger for better readability -->
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="myVisitRequestModalLabel">My Visit Requests</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <h5>Your Visit Requests</h5>
                                    {% if visit_requests %}
                                        <div class="list-group">
                                            {% for request in visit_requests %}
                                                <div class="list-group-item">
                                                    <h6 class="mb-1">{{ request.visitor_full_name }}</h6>
                                                    <p class="mb-1"><strong>Relation:</strong> {{ request.visitor_relation }}</p>
                                                    <p class="mb-1"><strong>Date:</strong> {{ request.visit_date|date:"Y-m-d H:i" }}</p>
                                                    <p class="mb-1"><strong>Purpose:</strong> {{ request.purpose }}</p>
                                                    <p class="mb-1"><strong>Status:</strong> {{ request.get_status_display }}</p>
                                                    <p class="mb-1"><strong>Visit to:</strong> {{ request.household_head.user.first_name }}</p>
                                                    <p class="mb-1"><strong>Coordinates:</strong> lat:{{ request.lat }}, lng: {{ request.lng }}</p>

                                                    {% if request.status == 'approved' %}
                                                        <a href="{% url 'ar_with_js' request.pk %}" type="button" class="btn btn-success">Navigate</a>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-warning" role="alert">
                                            You have no visit requests.
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>

            <!-- Sidebar Map Menu Button -->
            <i id="menuBtn" class="bi bi-list md:hidden absolute top-4 left-4 md:top-2 md:left-2 bg-white border border-gray-300 px-2.5 py-[.50rem] rounded cursor-pointer shadow-md hover:bg-gray-100 text-[1.5rem] z-[999]"></i>

            <div class="relative w-full md:w-[85%] h-full">
                <!--leflet map-->
                <div id="map" class="w-full h-full z-[9] relative"></div>

                <!-- Container for house buttons -->
                <div id="house-buttons" class="text-sm">
                    {% for house in labels %}
                        <div class="house-button shadow-md rounded-[20px] px-4 flex gap-2 items-center" data-index="{{ forloop.counter0 }}">
                            <img class="w-8 h-8 rounded-full" src="{{ house.photo.url }}" alt="" srcset=""> {{ house.property_name }}
                        </div>
                    {% endfor %}
                </div>       
                
                <!-- Legend HTML -->
                <div class="legend">
                    <h4 class="mb-2 font-bold">Phase Legend</h4>
                    <div class="legend-item" data-phase="1">
                        <div class="legend-color" style="background-color: orange;"></div>
                        <span>Phase 1</span>
                    </div>
                    <div class="legend-item" data-phase="2">
                        <div class="legend-color" style="background-color: lightblue;"></div>
                        <span>Phase 2</span>
                    </div>
                    <div class="legend-item" data-phase="3">
                        <div class="legend-color" style="background-color: lightgreen;"></div>
                        <span>Phase 3</span>
                    </div>
                    <div class="legend-item" data-phase="4">
                        <div class="legend-color" style="background-color: yellow;"></div>
                        <span>Phase 4</span>
                    </div>
                </div>

                <script>
                    // Grab the sidebar and menu button elements
                    const sidebarMap = document.getElementById('sidebarMap');
                    const menuBtn = document.getElementById('menuBtn');
                    const closeSidebarBtn = document.getElementById('closeSidebarBtn');

                    // Log to confirm button clicks
                    console.log("JS loaded");

                    // Open sidebar when menu button is clicked
                    menuBtn.addEventListener('click', () => {
                        console.log("Menu button clicked");
                        sidebarMap.classList.toggle('-left-[100%]');
                        sidebarMap.classList.toggle('left-0');
                    });

                    // Close sidebar when the close button is clicked
                    closeSidebarBtn.addEventListener('click', () => {
                        console.log("Close button clicked");
                        sidebarMap.classList.add('-left-[100%]');
                        sidebarMap.classList.remove('left-0');
                    });
                </script>
                
                <button id="closeMapBtn"
                    class="absolute top-4 right-4 md:top-2 md:right-2 flex items-center z-[999] bg-white border border-gray-300 px-2.5 py-1 rounded cursor-pointer shadow-md hover:bg-gray-100">
                    <i class="bi bi-x text-[1.5rem]"></i>
                </button>
            </div>
            <!-- <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1956.7927002116132!2d125.0229854054969!3d11.218280197230083!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x330877110e4e78c3%3A0x8ce9d2201a7a1fc4!2sBeta%20Bayview%20Homes!5e0!3m2!1sen!2sph!4v1728972017836!5m2!1sen!2sph" width="800" height="600" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe> -->
        </div>

        <div id="properties-data" style="display: none;">
            {% for property in labels %}
            <div class="property" 
                 data-property_name="{{ property.property_name|escapejs }}"
                 data-household_head="{{ property.household_head|default:'None'|escapejs }}"
                 data-household_profile="{{ property.household_head.profile_picture.url|default:'None'|escapejs }}"
                 data-lat="{{ property.latitude }}"
                 data-lng="{{ property.longitude }}"
                 data-photo="{{ property.photo.url|escapejs }}"
                 data-description="{{ property.property_description|escapejs }}"
                 data-id="{{ property.id }}"
                 data-block-no="{{ property.property_block_no }}"
                 data-house-no="{{ property.property_house_no }}">
            </div>
            {% endfor %}
        </div>   

        <div id="events-data" style="display: none;">
            {% for event in labels %}
            <div class="event" 
                 data-event_name="{{ event.event_name|escapejs }}"
                 data-event_description="{{ event.event_description|escapejs }}"
                 data-event_date="{{ event.event_date|date:'Y-m-d' }}"
                 data-event_time="{{ event.event_time|time:'H:i' }}"
                 data-location="{{ event.location|escapejs }}"
                 data-image="{{ event.image.url|escapejs }}">
            </div>
            {% endfor %}
        </div>          

        <!-- Modal for requesting a visit-->
        <div class="modal fade" id="visitRequestModal" tabindex="-1" aria-labelledby="visitRequestModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="visitRequestModalLabel">Request a Visit</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="visitRequestForm">
                            {% csrf_token %}
                            <input type="hidden" id="householdHead" name="household_head">
                            <input type="hidden" id="house_no" name="house_no">
                            <div class="mb-3">
                                <label for="visitorFullName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="visitorFullName" placeholder="Enter your full name" required>
                            </div>
                            <div class="mb-3">
                                <label for="visitorRelation" class="form-label">Relation to Homeowner</label>
                                <select class="form-control" id="visitorRelation" required>
                                    <option value="" disabled selected>Select Relation</option>
                                    <option value="Family">Family</option>
                                    <option value="Friend">Friend</option>
                                    <option value="Colleague">Colleague</option>
                                    <option value="Neighbor">Neighbor</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="visitDateTime" class="form-label">Date and Time of Visit</label>
                                <input type="datetime-local" class="form-control" id="visitDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="visitPurpose" class="form-label">Purpose of Visit</label>
                                <textarea class="form-control" id="visitPurpose" rows="3" placeholder="Briefly state the purpose of the visit" required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" form="visitRequestForm" id="submitRequestBtn" class="btn btn-primary">Submit Request</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        function openVisitRequestModal(householdHead, houseNo) {

            // Coordinates for houses 1-60
            const houses = [
                { number: 1, lat: 11.219784, lng: 125.023665 },
                { number: 2, lat: 11.219721, lng: 125.023620 },
                { number: 3, lat: 11.219627, lng: 125.023566 },
                { number: 4, lat: 11.219561, lng: 125.023520 },
                { number: 5, lat: 11.219492, lng: 125.023488 },
                { number: 6, lat: 11.219416, lng: 125.023426 },
                { number: 7, lat: 11.219353, lng: 125.023306 },
                { number: 8, lat: 11.219319, lng: 125.023182 },
                { number: 9, lat: 11.219274, lng: 125.023094 },
                { number: 10, lat: 11.219258, lng: 125.023008 },
                { number: 11, lat: 11.219240, lng: 125.022919 },
                { number: 12, lat: 11.219195, lng: 125.022804 },
                { number: 13, lat: 11.219179, lng: 125.022723 },
                { number: 14, lat: 11.219145, lng: 125.022651 },
                { number: 15, lat: 11.219106, lng: 125.022565 },
                { number: 16, lat: 11.219077, lng: 125.022463 },
                { number: 17, lat: 11.219035, lng: 125.022353 },
                { number: 18, lat: 11.218998, lng: 125.022238 },
                { number: 19, lat: 11.218979, lng: 125.022152 },
                { number: 20, lat: 11.218958, lng: 125.022066 },
                { number: 21, lat: 11.220047, lng: 125.023319 },
                { number: 22, lat: 11.219947, lng: 125.023233 },
                { number: 23, lat: 11.219842, lng: 125.023163 },
                { number: 24, lat: 11.219600, lng: 125.022943 },
                { number: 25, lat: 11.219495, lng: 125.022712 },
                { number: 26, lat: 11.219406, lng: 125.022498 },
                { number: 27, lat: 11.219342, lng: 125.022321 },
                { number: 28, lat: 11.219279, lng: 125.022101 },
                { number: 29, lat: 11.219174, lng: 125.021934 },
                { number: 30, lat: 11.220258, lng: 125.023061 },
                { number: 31, lat: 11.220326, lng: 125.022889 },
                { number: 32, lat: 11.220437, lng: 125.022755 },
                { number: 33, lat: 11.220511, lng: 125.022664 },
                { number: 34, lat: 11.220605, lng: 125.022503 },
                { number: 35, lat: 11.220700, lng: 125.022385 },
                { number: 36, lat: 11.220063, lng: 125.022830 },
                { number: 37, lat: 11.220168, lng: 125.022610 },
                { number: 38, lat: 11.220426, lng: 125.023453 },
                { number: 39, lat: 11.220463, lng: 125.022272 },
                { number: 40, lat: 11.220568, lng: 125.022101 },
                { number: 41, lat: 11.219816, lng: 125.022557 },
                { number: 42, lat: 11.219774, lng: 125.022364 },
                { number: 43, lat: 11.219669, lng: 125.022106 },
                { number: 44, lat: 11.219600, lng: 125.021865 },
                { number: 45, lat: 11.220132, lng: 125.022101 },
                { number: 46, lat: 11.220253, lng: 125.021860 },
                { number: 47, lat: 11.219953, lng: 125.021806 },
                { number: 48, lat: 11.219890, lng: 125.021564 },
                { number: 49, lat: 11.220079, lng: 125.021532 },
                { number: 50, lat: 11.219079, lng: 125.021688 },
                { number: 51, lat: 11.218906, lng: 125.021505 },
                { number: 52, lat: 11.218753, lng: 125.021344 },
                { number: 53, lat: 11.218611, lng: 125.021173 },
                { number: 54, lat: 11.218495, lng: 125.021006 },
                { number: 55, lat: 11.218343, lng: 125.020872 },
                { number: 56, lat: 11.220810, lng: 125.021919 },
                { number: 57, lat: 11.220668, lng: 125.021699 },
                { number: 58, lat: 11.220434, lng: 125.021372 },
                { number: 59, lat: 11.220639, lng: 125.020943 },
                { number: 60, lat: 11.221024, lng: 125.021466 }
            ];

            console.log("Household Head:", householdHead);  // Debug: Check if householdHead is passed correctly
            console.log("House number:", houseNo);  // Debug: Check if householdHead is passed correctly
            
            const modalTitle = document.getElementById('visitRequestModalLabel');
            if (modalTitle) {
                // Set the title with the household head's name or fallback to a default
                modalTitle.textContent = `Request a Visit for ${householdHead || "Homeowner"}`;
                console.log("Modal Title Updated:", modalTitle.textContent);  // Debug: Check the updated title
                console.log("fetched house no:", houseNo)
            }

            // Set the hidden input value
            const householdHeadInput = document.getElementById('householdHead');
            const houseNoInput = document.getElementById('house_no');
            // if (M) {
            //     householdHeadInput.value = householdHead || "Homeowner";
            //     console.log("Hidden Input Updated:", householdHeadInput.value);  // Debug: Check the updated input value
            // }

            householdHeadInput.value = householdHead || "Homeowner";
            houseNoInput.value = houseNo;
            console.log("Hidden Input Updated:", householdHeadInput.value);  // Debug: Check the updated input value

            // Initialize and show the modal
            const modal = new bootstrap.Modal(document.getElementById('visitRequestModal'), {
                backdrop: false, // 'static' keeps the modal open even if you click on the backdrop, 'false' would remove the backdrop entirely
            });
            modal.show();

            $(document).ready(function() {
                // Get the CSRF token from the meta tag
                const csrfToken = $('meta[name="csrf-token"]').attr('content');
                const loader = document.getElementById('loadingSpinner');

                $('#submitRequestBtn').click(function(event) {
                    event.preventDefault();

                    const requestUrl = "{% url 'submit_visit_request' %}";
                    console.log("AJAX Request URL:", requestUrl);  // Debugging line

                    // Collect form data
                    const visitorFullName = $('#visitorFullName').val();
                    const visitorRelation = $('#visitorRelation').val();
                    const visitDate = $('#visitDate').val();
                    const purpose = $('#visitPurpose').val();
                    const householdHead = $('#householdHead').val();
                    const houseNo = parseInt($('#house_no').val());

                    // Log household head for troubleshooting
                    console.log("Household Head:", householdHead);

                    // Find the coordinates for the household head's house number
                    const houseData = houses.find(house => house.number === houseNo);

                    console.log("Matching House Data:", houseData);  // Log matched house data for debugging

                    if (!visitorFullName || !visitorRelation || !visitDate || !purpose) {
                        alert("Please fill in all required fields.");
                        return;
                    } else {
                        loader.classList.remove('hidden');

                        // Prepare the data to send, including latitude and longitude if found
                        const requestData = {
                            visitor_full_name: visitorFullName,
                            visitor_relation: visitorRelation,
                            visit_date: visitDate,
                            purpose: purpose,
                            household_head: householdHead,
                            house_no: houseNo,  // Pass house number for reference
                            lat: houseData ? houseData.lat : null,  // Include latitude if available
                            lng: houseData ? houseData.lng : null   // Include longitude if available
                        };

                        console.log("Request Data:", requestData);  // Log request data for debugging

                        // Proceed with your AJAX request
                        $.ajax({
                            url: requestUrl,
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(requestData),
                            headers: { 'X-CSRFToken': csrfToken },
                            success: function(response) {
                                loader.classList.add('hidden');
                                $('#visitRequestModal').modal('hide');
                                $('#visitRequestForm')[0].reset();
                                window.location.reload();
                            },
                            error: function(xhr, status, error) {
                                alert("There was an error submitting your request. Please try again.");
                                console.error("Error:", status, error);
                            }
                        });
                    }

                });

            });

        }
    </script>

    <script>
       document.addEventListener('DOMContentLoaded', function () {
			initMap()
        })

        const users = document.querySelectorAll('.user');
        const user = document.getElementById('user');
        const conBtn = document.getElementById('conBtn');
        const mapContainer = document.getElementById('mapContainer');
        const closeMapBtn = document.getElementById('closeMapBtn');
        const mapMessage = document.getElementById('mapMessage');

        closeMapBtn.addEventListener('click', () => {
            window.location.href = '{% url "homepage" %}'
        });

        function initMap() {
            if (document.getElementById('map').children.length > 0) return;

            // Beta Bayview Homes location
            const initialLat = 11.219932;
            const initialLng = 125.022637;

            // Set the map view to Beta Bayview location with maximum zoom level
            const map = L.map('map').setView([initialLat, initialLng], 16);

            map.zoomControl.remove();

            // Load the map tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            // Coordinates for houses 1-20
            const houses = [
                { number: 1, lat: 11.219784, lng: 125.023665 },
                { number: 2, lat: 11.219721, lng: 125.023620 },
                { number: 3, lat: 11.219627, lng: 125.023566 },
                { number: 4, lat: 11.219561, lng: 125.023520 },
                { number: 5, lat: 11.219492, lng: 125.023488 },
                { number: 6, lat: 11.219416, lng: 125.023426 },
                { number: 7, lat: 11.219353, lng: 125.023306 },
                { number: 8, lat: 11.219319, lng: 125.023182 },
                { number: 9, lat: 11.219274, lng: 125.023094 },
                { number: 10, lat: 11.219258, lng: 125.023008 },
                { number: 11, lat: 11.219240, lng: 125.022919 },
                { number: 12, lat: 11.219195, lng: 125.022804 },
                { number: 13, lat: 11.219179, lng: 125.022723 },
                { number: 14, lat: 11.219145, lng: 125.022651 },
                { number: 15, lat: 11.219106, lng: 125.022565 },
                { number: 16, lat: 11.219077, lng: 125.022463 },
                { number: 17, lat: 11.219035, lng: 125.022353 },
                { number: 18, lat: 11.218998, lng: 125.022238 },
                { number: 19, lat: 11.218979, lng: 125.022152 },
                { number: 20, lat: 11.218958, lng: 125.022066 },
                { number: 21, lat: 11.220047, lng: 125.023319 },
                { number: 22, lat: 11.219947, lng: 125.023233 },
                { number: 23, lat: 11.219842, lng: 125.023163 },
                { number: 24, lat: 11.219600, lng: 125.022943 },
                { number: 25, lat: 11.219495, lng: 125.022712 },
                { number: 26, lat: 11.219406, lng: 125.022498 },
                { number: 27, lat: 11.219342, lng: 125.022321 },
                { number: 28, lat: 11.219279, lng: 125.022101 },
                { number: 29, lat: 11.219174, lng: 125.021934 },
                { number: 30, lat: 11.220258, lng: 125.023061 },
                { number: 31, lat: 11.220326, lng: 125.022889 },
                { number: 32, lat: 11.220437, lng: 125.022755 },
                { number: 33, lat: 11.220511, lng: 125.022664 },
                { number: 34, lat: 11.220605, lng: 125.022503 },
                { number: 35, lat: 11.220700, lng: 125.022385 },
                { number: 36, lat: 11.220063, lng: 125.022830 },
                { number: 37, lat: 11.220168, lng: 125.022610 },
                { number: 38, lat: 11.220426, lng: 125.023453 },
                { number: 39, lat: 11.220463, lng: 125.022272 },
                { number: 40, lat: 11.220568, lng: 125.022101 },
                { number: 41, lat: 11.219816, lng: 125.022557 },
                { number: 42, lat: 11.219774, lng: 125.022364 },
                { number: 43, lat: 11.219669, lng: 125.022106 },
                { number: 44, lat: 11.219600, lng: 125.021865 },
                { number: 45, lat: 11.220132, lng: 125.022101 },
                { number: 46, lat: 11.220253, lng: 125.021860 },
                { number: 47, lat: 11.219953, lng: 125.021806 },
                { number: 48, lat: 11.219890, lng: 125.021564 },
                { number: 49, lat: 11.220079, lng: 125.021532 },
                { number: 50, lat: 11.219079, lng: 125.021688 },
                { number: 51, lat: 11.218906, lng: 125.021505 },
                { number: 52, lat: 11.218753, lng: 125.021344 },
                { number: 53, lat: 11.218611, lng: 125.021173 },
                { number: 54, lat: 11.218495, lng: 125.021006 },
                { number: 55, lat: 11.218343, lng: 125.020872 },
                { number: 56, lat: 11.220810, lng: 125.021919 },
                { number: 57, lat: 11.220668, lng: 125.021699 },
                { number: 58, lat: 11.220434, lng: 125.021372 },
                { number: 59, lat: 11.220639, lng: 125.020943 },
                { number: 60, lat: 11.221024, lng: 125.021466 }
            ];

            const events = [
                {number: 1, lat: 11.220015, lng: 125.022916},
                {number: 2, lat: 11.219448, lng: 125.023395},
                {number: 3, lat: 11.219633, lng: 125.022170},
                {number: 4, lat: 11.220125, lng: 125.022689},
                {number: 5, lat: 11.219642, lng: 125.021427},
                {number: 6, lat: 11.219765, lng: 125.022180},
                {number: 7, lat: 11.219000, lng: 125.021000},
                {number: 8, lat: 11.218500, lng: 125.020700},
                {number: 9, lat: 11.218800, lng: 125.021200},
            ];


            // Fetch properties data from the rendered HTML
            const properties = Array.from(document.querySelectorAll('#properties-data .property')).map(property => {
                return {
                    property_name: property.getAttribute('data-property_name'),
                    household_head: property.getAttribute('data-household_head'),
                    photo: property.getAttribute('data-photo'),
                    property_description: property.getAttribute('data-description'),
                    household_profile: property.getAttribute('data-household_profile'),
                    property_block_no: property.getAttribute('data-block-no'),
                    property_house_no: property.getAttribute('data-house-no'),
                    id: parseInt(property.getAttribute('data-id')),
                };
            });

            // Initialize markers array to store each marker
            let markers = [];

            // Create a custom marker using a div
            function createCustomMarkerImage(imageUrl) {
                const markerDiv = document.createElement('div');
                markerDiv.className = 'custom-marker';

                // Set the background image
                markerDiv.style.backgroundImage = `url(${imageUrl})`;
                markerDiv.style.backgroundSize = 'cover'; // Cover the entire area
                markerDiv.style.backgroundPosition = 'center'; // Center the image
                markerDiv.style.borderRadius = '50%'; // Make it circular
                markerDiv.style.width = '30px'; // Width of the marker
                markerDiv.style.height = '30px'; // Height of the marker

                return markerDiv;
            }

            // Create markers for each house using the fixed coordinates
            houses.forEach((house, index) => {
                // Check if there is a corresponding property for the house
                if (index < properties.length) {
                    const property = properties[index];

                    let householdHeadImage = property.photo 
                    
                    // Placeholder URL for a generic user profile image
                    const placeholderImageUrl = "https://via.placeholder.com/64?text=User"; // Replace this with any URL you prefer

                    // Determine householdHeadContent based on owner presence
                    let householdHeadContent;

                    if (property.household_head && property.household_profile) {
                        // If there is an owner and a profile image, display the image
                        householdHeadContent = `<img class="h-8 w-8 rounded-full" src="${property.household_profile}" alt="Household Head">`;
                    } else {
                        // If no owner, display the placeholder image
                        householdHeadContent = `<img class="h-8 w-8 rounded-full" src="${placeholderImageUrl.url}" alt="No Owner">`;
                    }

                    // Define the popup content
                    const housePopup = `
                        <div class="popup-container">
                            <div class="popup-title">
                                <strong>${property.property_name}</strong><br>
                                <em class="popup-head flex items-center gap-2">${householdHeadContent} ${property.household_head ? property.household_head : 'Owner:'}</em>
                            </div>
                            <img src="${property.photo || "{% static 'users/pope-francis-village.png' %}"}" alt="${property.property_name}" class="popup-image">
                            <p class="popup-description">Owner: ${property.household_head}</p>
                            <p class="popup-description">House type: ${property.property_description}</p>
                            <p class="popup-description">Block no: ${property.property_block_no}</p>
                            <p class="popup-description">House no: ${property.property_house_no}</p>
                            <a class="popup-button text-white cursor-pointer" onclick="openVisitRequestModal('${property.household_head}','${property.property_house_no}')">Request a visit</a>
                        </div>
                    `;
                    
                    // Create a custom marker using a div
                    const customIcon = L.divIcon({
                        className: 'custom-icon',
                        html: createCustomMarkerImage(householdHeadImage).outerHTML, // Set the inner HTML to the circular image div
                        iconSize: [30, 30], // Size of the icon
                        iconAnchor: [15, 30], // Point of the icon which will correspond to marker's location
                        popupAnchor: [0, -30] // Point from which the popup should open relative to the iconAnchor
                    });

                    // Create a marker and add it to the map
                    const marker = L.marker([house.lat, house.lng], { icon: customIcon }) // Set the custom icon
                        .addTo(map)
                        .bindPopup(housePopup);

                    // Store the marker in the markers array at the same index
                    markers[index] = marker;
                } else {
                    console.warn(`Property at index ${index} is undefined.`);
                }
            });

            function showHouseData(index) {
                const house = houses[index];
                // Adjust the latitude directly
                const adjustedLat = house.lat + 0.001; // Change this value as needed

                // Set the new view
                map.setView([adjustedLat, house.lng], 19); // Center the map on the new position


                // Check if the marker exists before opening its popup
                if (markers[index]) {
                    // Optionally, use a custom offset
                    // const popupOffset = L.point(0, -window.innerHeight * 0.3); // Uncomment if you want to use a specific offset
                    markers[index].openPopup(); // Open the popup for the marker
                } else {
                    console.error(`No marker found for house index: ${index}`);
                }
            }

            // Attach click event listeners to buttons
            document.querySelectorAll('.house-button').forEach((button, index) => {
                button.addEventListener('click', function() {
                    // Remove 'button-active' class from all buttons
                    document.querySelectorAll('.house-button').forEach(btn => {
                        btn.classList.remove('button-active');
                    });
                    
                    // Add 'button-active' class to the clicked button
                    button.classList.add('button-active');
                    
                    // Show house data for the clicked button
                    showHouseData(index);
                });
            });


            // Custom search function
            const searchHouse = (query) => {
                const lowerCaseQuery = query.toLowerCase();
                const matchedHouses = houses.filter(house =>
                    house.property_name.toLowerCase().includes(lowerCaseQuery) ||
                    house.household_head.toLowerCase().includes(lowerCaseQuery)
                );

                if (matchedHouses.length > 0) {
                    // If matches are found, center the map on the first match
                    const firstMatch = matchedHouses[0];
                    map.setView([firstMatch.lat, firstMatch.lng], 19); // Zoom in on the matched house

                    // Optionally, you can add a marker or highlight the matched house here
                    L.marker([firstMatch.lat, firstMatch.lng])
                        .addTo(map)
                        .bindPopup(`<strong>${firstMatch.property_name}</strong><br>Household Head: ${firstMatch.household_head}`)
                        .openPopup();
                } else {
                    alert('No houses found matching that query.');
                }
            };

            let phasemarkers = []; // Store the markers for the phases

            // Define the coordinates for Phase 1 hexagon
            const phase1Coordinates = [
                [11.220279, 125.023206], // Point 1
                [11.219811, 125.022900], // Point 2
                [11.219337, 125.021752], // Point 3
                [11.218906, 125.022101], // Point 4
                [11.219211, 125.023518], // Point 5
                [11.219805, 125.023877], // Point 6
            ];

            // Create the hexagon for Phase 1
            const shadedHexagon = L.polygon(phase1Coordinates, {
                color: 'transparent', // Border color
                fillColor: 'orange', // Fill color
                fillOpacity: 0.4, // Transparency of the fill
                interactive: false, // Disable mouse events for this polygon
            }).addTo(map).bindPopup('Phase 1 Area');

            phasemarkers.push(shadedHexagon);

            // Bind a popup to the hexagon
            shadedHexagon.bindPopup('Phase 1 Area');

            // Optional: Set the view to include the shaded area
            map.fitBounds(shadedHexagon.getBounds());

            // Define the coordinates for Phase 2 hexagon
            const phase2Coordinates = [
                [11.220863, 125.022310], // Point 1
                [11.219942, 125.021221], // Point 2
                [11.219353, 125.021730], // Point 3
                [11.219837, 125.022884], // Point 4
                [11.220274, 125.023174], // Point 5
            ];

            // Create the hexagon for Phase 2 without a border
            const shadedHexagonPhase2 = L.polygon(phase2Coordinates, {
                color: 'transparent', // No border color
                fillColor: 'lightblue', // Different fill color for distinction
                fillOpacity: 0.4, // Lighter transparency of the fill
                interactive: false, // Disable mouse events for this polygon
            }).addTo(map).bindPopup('Phase 2 Area');

            phasemarkers.push(shadedHexagonPhase2);

            // Bind a popup to the hexagon
            shadedHexagonPhase2.bindPopup('Phase 2 Area');

            // Define the coordinates for Phase 3 polygon
            const phase3Coordinates = [
                [11.219527, 125.021570], // Point 1
                [11.218483, 125.020396], // Point 2
                [11.218031, 125.021056], // Point 3
                [11.218898, 125.022094], // Point 4
            ];

            // Create the polygon for Phase 3 without a border
            const shadedPolygonPhase3 = L.polygon(phase3Coordinates, {
                color: 'transparent', // No border color
                fillColor: 'lightgreen', // Fill color for Phase 3
                fillOpacity: 0.4, // Lighter transparency of the fill
                interactive: false, // Disable mouse events for this polygon
            }).addTo(map).bindPopup('Phase 3 Area');

            phasemarkers.push(shadedPolygonPhase3);

            // Bind a popup to the polygon
            shadedPolygonPhase3.bindPopup('Phase 3 Area');

            // Define the coordinates for Phase 4 polygon
            const phase4Coordinates = [
                [11.221337, 125.021527], // Point 1
                [11.220705, 125.021183], // Point 2
                [11.220974, 125.020969], // Point 3
                [11.220763, 125.020636], // Point 4
                [11.219976, 125.021240], // Point 5
                [11.220860, 125.022300], // Point 6
            ];

            // Create the polygon for Phase 4 without a border
            const shadedPolygonPhase4 = L.polygon(phase4Coordinates, {
                color: 'transparent', // No border color
                fillColor: 'yellow', // Fill color for Phase 4
                fillOpacity: 0.3, // Lighter transparency of the fill
                interactive: false, // Disable mouse events for this polygon
            }).addTo(map).bindPopup('Phase 4 Area');

            phasemarkers.push(shadedPolygonPhase4);

            // Bind a popup to the polygon
            shadedPolygonPhase4.bindPopup('Phase 4 Area');

            // Optional: Set the view to include all shaded areas
            const bounds = L.latLngBounds(
                phase1Coordinates.concat(phase2Coordinates, phase3Coordinates, phase4Coordinates)
            );
            map.fitBounds(bounds);

            // Add click event listeners to the legend items
            document.querySelectorAll('.legend-item').forEach(item => {
                item.addEventListener('click', function() {
                    const phaseIndex = this.getAttribute('data-phase') - 1; // Get the phase index

                    // Check if the marker exists before opening its popup
                    if (phasemarkers[phaseIndex]) {
                        phasemarkers[phaseIndex].openPopup(); // Open the popup for the corresponding phase
                    }
                });
            });

             // Add a click event listener to the map
            map.on('click', function(event) {
                // Get latitude and longitude from the event object
                const { lat, lng } = event.latlng;

                // Display latitude and longitude, for example in a popup
                L.popup()
                    .setLatLng(event.latlng)
                    .setContent(`Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`)
                    .openOn(map);

                // Optionally, you could log the coordinates to the console
                console.log(`Latitude: ${lat}, Longitude: ${lng}`);
            });

            // Function to get URL parameters
            function getUrlParameter(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }

            // Check if the filter is set to 'events'
            if (getUrlParameter('filter') === 'events') {
                clearMarkers(); // Clear existing markers if applicable

                // Iterate through each event and create markers
                events.forEach(event => {
                    const eventName = `Event ${event.number}`; // Event name
                    const eventDescription = `Description for Event ${event.number}`; // Event description
                    const eventDate = "2024-11-01"; // Example date
                    const eventTime = "10:00"; // Example time
                    const image = "path/to/image.jpg"; // Example image URL

                    // Create the marker on the map using the event's lat and lng
                    addMarker([event.lat, event.lng], { // Use an array for Leaflet
                        title: eventName,
                        description: eventDescription,
                        date: eventDate,
                        time: eventTime,
                        image: image
                    });
                });
            }

            // Function to add a marker using Leaflet
            function addMarker(location, options) {
                const marker = L.marker(location).addTo(map); // Create and add the marker to the Leaflet map

                // Bind a popup to the marker with the event details
                marker.bindPopup(`
                    <div style="max-width: 200px;">
                        <h3>${options.title}</h3>
                        <p>${options.description}</p>
                        <p><strong>Date:</strong> ${options.date}</p>
                        <p><strong>Time:</strong> ${options.time}</p>
                        <img src="${options.image}" alt="${options.title}" style="width:100%; height:auto;">
                    </div>
                `); // Use Leaflet's bindPopup method
            }


            function clearMarkers() {
                markers.forEach(marker => {
                    map.removeLayer(marker); // Remove each marker from the map
                });
                markers = []; // Reset the markers array
            }

        }
    </script>
</body>

</html>